import { KNOWLEDGE } from "../netlify/functions/knowledge.mjs";
import { chunkKnowledge } from "../netlify/functions/chunker.mjs";
import { buildBm25Index } from "../netlify/functions/bm25.mjs";
import { tokenize } from "../netlify/functions/text-utils.mjs";
import { writeFileSync } from "fs";
import { dirname, join } from "path";
import { fileURLToPath } from "url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const outFile = join(__dirname, "..", "netlify", "functions", "rag-data.mjs");

console.log("Building RAG index...");

const chunks = chunkKnowledge(KNOWLEDGE);
console.log(`  Chunked knowledge into ${chunks.length} chunks`);

const index = buildBm25Index(chunks, tokenize);
console.log(`  BM25 index: ${Object.keys(index.docs).length} docs, ${Object.keys(index.idf).length} terms`);
console.log(`  Average document length: ${index.avgDl.toFixed(1)} tokens`);

const moduleSource =
  "// Auto-generated by build-rag-index.mjs — do not edit\n" +
  "export const RAG_CHUNKS = " + JSON.stringify(chunks) + ";\n" +
  "export const RAG_INDEX = " + JSON.stringify(index) + ";\n";

writeFileSync(outFile, moduleSource);

console.log("RAG index built successfully");
console.log(`  → ${outFile}`);
